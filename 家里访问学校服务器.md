## 家里到阿里云服务器免密登陆

1. 本地生成ssh密钥对
   ```bash
   ssh-keygen -t rsa
   ```
2. 将生成的公钥文件复制到阿里云服务器根目录，然后追加
   ```bash
   cat id_rsa.pub >> .ssh/authorized_keys
   ```

3. 在阿里云上给予访问权限：
   ```bash
   chmod 700 ~/.ssh/
   chmod 600 ~/.ssh/authorized_keys
   ```
4. 
   ```bash
   sudo vim /etc/ssh/sshd_config

   RSAAuthentication yes
   PubkeyAuthentication yes
   PasswordAuthentication no（这个看需要，设不设定都可以）
   ```
5. 
    重启ssh sudo service sshd restart   
    重启ssh服务/etc/init.d/ssh restart

6.  vscode上配置好Hostname, User, Port即可   

现在只是完成了本地到阿里云的免密登陆。接下来要配置阿里云访问学校服务器。
1. 在学校服务器上生成密钥
   ```bash
   ssh-keygen -t rsa
   ```
   生成的公私钥在 ~/.ssh/里边 id_rsa.pub为公钥
2. 将生成的公钥推送到阿里云服务器，这样学校服务器访问阿里云服务器，可以实现免密登陆。
   
   abc.de.fgh.ijk为阿里云公网ip地址
   ```bash
   ssh-copy-id -i ~/.ssh/id_rsa.pub root@abc.de.fgh.ijk -p 22
   ```

3. 安装autossh（sever client）?
   ```bash
   apt-get install autossh
   ```

4. 测试autossh 和 实验室访问 阿里云 是否成功
   ```bash
   autossh -M -NfR 9797:localhost:22 root@abc.de.fgh.ijk
   ```
   9797是阿里云端口


5. 登陆阿里云验证
   ```bash
   watch -n 1 netstat -tnlp
   ```

![图 1](images/b5098e5f6a7ac9bee02fb1ee16ada6fd430e44009997335e1b0dc6cef73f4056.png)  

   这个时候我们 
   ```bash
   ssh username@localhost -p 9797
   ```
   就可以连接实验室服务器了
   疑问是 localhost 代表那个ip地址？？？

6. 下面我们在实验室服务器继续配置autossh.service
   ```bash
   vim /lib/systemd/system/autossh.service

   [Unit]
   Description=Auto SSH Tunnel
   After=network-online.target
   [Service]
   User=user（用户名）
   Type=simple
   ExecStart=/usr/bin/autossh -NR 9797:localhost:22 -i /home/user/.ssh/id_rsa 
   root@abc.de.fgh.ijk -p 22 >> /dev/null 2>&1
   ExecReload=/bin/kill -HUP $MAINPID
   ExecStop=/bin/kill -TERM $MAINPID
   KillMode=process
   Restart=no
   [Install]
   WantedBy=multi-user.target
   WantedBy=graphical.target
   ```
   
   ```bash
   systemctl enable autossh

   systemctl status autossh
   ```

   接着在阿里云上输入
   ```
   watch -n 1 netstat -tnlp
   ```
   可以看到
   ![图 2](images/f2960f468a963909ca097d6f20583101f3abd829b72d0666567e0d2314667233.png)  

突然vscode提示 可以 远程 jupyter lab了
？？端口占用

参考：
1. [外网如何连接校园网GPU服务器以及文件传输](https://zhuanlan.zhihu.com/p/110201020)


